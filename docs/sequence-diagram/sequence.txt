title Admin List Transactions
actor admin
boundary Spring Dispatcher Serverlet
control AuthInterceptor
control AdminInterceptor
control AdminTransactionController
entity TransactionModel

admin ->Spring Dispatcher Serverlet : Get /admin/transactions
Spring Dispatcher Serverlet ->AuthInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AuthInterceptor -->Spring Dispatcher Serverlet: True
Spring Dispatcher Serverlet ->AdminInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AdminInterceptor -->Spring Dispatcher Serverlet : True
Spring Dispatcher Serverlet ->AdminTransactionController : listTransactions()
AdminTransactionController ->TransactionModel : select(t -> true)
TransactionModel -->AdminTransactionController : ArrayList<Transaction>
AdminTransactionController -->Spring Dispatcher Serverlet : ArrayList<Transaction>
else returns false
AdminInterceptor -->Spring Dispatcher Serverlet : throws ResponseStatusException
end
else returns false
AuthInterceptor -->Spring Dispatcher Serverlet : throws ResponseStatusException

end
==================================================
title SignUp

actor user
boundary Spring Dispatcher Serverlet
control AuthController
boundary UserModel

user ->Spring Dispatcher Serverlet : POST /signup
Spring Dispatcher Serverlet ->AuthController : signUp( SignUpBody body)
AuthController -> UserModel : recordExists(userEmail)
alt returns true
UserModel -->AuthController : True
AuthController -->Spring Dispatcher Serverlet : throw new ResponseStatusException()
else returns false
UserModel -->AuthController : False
AuthController ->UserModel : insert(new User(user information))
UserModel -->AuthController :
AuthController -->Spring Dispatcher Serverlet :
end
========================================
title Refund Request

actor user
boundary Spring Dispatcher Serverlet
control AuthInterceptor
control TransactionController

boundary RefundRequestModel
boundary UserModel
user ->Spring Dispatcher Serverlet : POST /transactions/{id}/refund
Spring Dispatcher Serverlet ->AuthInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AuthInterceptor -->Spring Dispatcher Serverlet: True
Spring Dispatcher Serverlet ->TransactionController : requestRefund(Context ctx, int id)
TransactionController ->RefundRequestModel : recordExists(userEmail, transactionId)
alt returns true
RefundRequestModel -->TransactionController : True
TransactionController -->Spring Dispatcher Serverlet: throw new ResponseStatusException(HttpStatus.BAD_REQUEST)
else returns false
RefundRequestModel -->TransactionController: False
TransactionController ->RefundRequestModel : selectOne(userEmail, id)
RefundRequestModel --> TransactionController : TargetTransactoin (Transaction Object)
alt targetTransaction is not found
TransactionController -->Spring Dispatcher Serverlet : throw new ResponseStatusException(HttpStatus.BAD_REQUEST)
else targetTransaction is found
alt targetTransaction is of type refund
TransactionController -->Spring Dispatcher Serverlet : throw new ResponseStatusException(HttpStatus.BAD_REQUEST)
else transaction if not of type refund
TransactionController -> UserModel : insert(new RefundRequest(RefundRequest information)
UserModel-->TransactionController:
TransactionController-->Spring Dispatcher Serverlet:
end
end

end
else returns False
AuthInterceptor -->Spring Dispatcher Serverlet : throws ResponseStatusException
end
=====================================
title Recharge
actor user
boundary Spring Dispatcher Serverlet
control AuthInterceptor
control UserController
boundary TransactionModel
boundary UserModel
user ->Spring Dispatcher Serverlet : POST /user/recharge
Spring Dispatcher Serverlet ->AuthInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AuthInterceptor -->Spring Dispatcher Serverlet: True

Spring Dispatcher Serverlet ->UserController : rechargeWallet(Contex ctx, RechargeWalletBody body)
alt body.cardNumber is negative
UserController -->Spring Dispatcher Serverlet : throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Invalid card number");
else body.cardNumber is positive
alt body.amount < 0

UserController --> Spring Dispatcher Serverlet : throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Invalid amount")
else body.amount >= 0
UserController ->UserModel : update(u -> new User(u.email, u.username, u.password, u.isAdmin, u.wallet + body.amount), u -> u.email.equals(ctx.email))
UserModel -->UserController :
UserController ->TransactionModel : insert(new Transaction(Util.incrementOrInitialize(transactionModel.selectMax(t -> t.id)), ctx.email, LocalDateTime.now(), -body.amount, TransactionType.ADD_TO_WALLET, "None", "None"));
TransactionModel -->UserController:
UserController -->Spring Dispatcher Serverlet:
end
end
else returns False
AuthInterceptor -->Spring Dispatcher Serverlet: throws ResponseStatusException
end
==============================================
title pay using cash

actor user
boundary Spring Dispatcher Serverlet
control AuthInterceptor
control PaymentController
control ServiceController
control DiscountControlller
entity ProviderModel
entity DiscountModel
entity UsedDiscountModel
entity TransactionModel
participant CashOnDeliveryStrategy

participant handlerFactory

participant ErroneousHandler
participant handler

entity handlers

user->Spring Dispatcher Serverlet : POST /services/{serviceName}/providers/{providerName}/pay-cash
Spring Dispatcher Serverlet ->AuthInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AuthInterceptor -->Spring Dispatcher Serverlet: True
Spring Dispatcher Serverlet ->PaymentController : payCashOnDelivery(@RequestAttribute("context") Context ctx, @PathVariable("serviceName") String serviceName, @PathVariable("providerName") String providerName, @RequestBody PaymentBody body)

PaymentController ->ServiceController : getServiceProvider(serviceName, providerName)
ServiceController ->ServiceController : getService(serviceName)
ServiceController ->ProviderModel:selectOne(p -> p.serviceName.equals(serviceName) && p.name.equals(providerName))
ProviderModel -->ServiceController: Provider
alt provider = null
ServiceController -->PaymentController: throw new ResponseStatusException(HttpStatus.NOT_FOUND, "Could not find a provider with such a name providing such a service")
PaymentController -->Spring Dispatcher Serverlet:
else provider != null
ServiceController -->PaymentController : provider
alt !provider.CashOnDelivery
PaymentController-->Spring Dispatcher Serverlet: throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "This provider does not provide cash on delivery")
PaymentController-->*CashOnDeliveryStrategy:<<create>>
end
PaymentController ->PaymentController : payToProvider(ctx.email, provider, body.handlerRequest, cashOnDeliveryStrategy)
PaymentController-->*handlerFactory:<<create>>
PaymentController ->handlerFactory: getHandler(provider.handlerName)
alt !handlers.containsKey(handlerName)
handlerFactory ->* ErroneousHandler:<<create>>
handlerFactory -->PaymentController : ErroneousHandler

end
handlerFactory -->handlers : get(handlerName);
handlers -->handlerFactory : handler
handlerFactory -->PaymentController : handler

end
PaymentController -> *handler: <<create>>
PaymentController -> handler: validateAndHandleRequest(request)
alt !requestContainsAllKeys(request)
handler ->*handlerResponse: <<create>>
handler -->PaymentController: handlerResponse
else requestContainsAllKeys(request)
handler->handler:handleRequestAndGetAmount(request)
alt !res.success
	handler -->PaymentController: handlerResponse
end
	handler -->PaymentController: handlerResponse

alt !handlerRes.success
PaymentController -->Spring Dispatcher Serverlet:throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "The form handler was not able to handle this request:\n" + handlerRes.errorMessage)
end
PaymentController ->DiscountControlller:getDiscountsForServiceForUser(email, provider.serviceName)
DiscountControlller ->DiscountModel: (d -> d.isActive && (d.type == DiscountType.OVERALL || (d.type == DiscountType.SPECIFIC && d.serviceName.equals(serviceName))))
DiscountControlller ->*Discounts: <<create>>
DiscountControlller ->DiscountControlller: getEffectiveDiscountsForUser(email, discounts)
DiscountControlller ->UsedDiscountModel: select(d -> d.email.equals(email))

UsedDiscountModel -->DiscountControlller : ArrayList<UsedDiscounts>
DiscountControlller -> Discounts: removeIf(d -> usedDiscountsIds.contains(d.id))
Discounts -->DiscountControlller : ArrayList<Discounts>user
DiscountControlller -->PaymentController: Discounts
PaymentController ->CashOnDeliveryStrategy : pay(amountToDeduct)
CashOnDeliveryStrategy -->PaymentController:
PaymentController -> * transactionToInsert:<<create>>
PaymentController ->TransactionModel: insert(transactionToInsert)
TransactionModel -->PaymentController:
alt discount.type == DiscountType.OVERALL
PaymentController ->DiscountControlller : useDiscount(email, discount.id)
end
PaymentController -->Spring Dispatcher Serverlet:
end

else returns False
AuthInterceptor -->Spring Dispatcher Serverlet: throws ResponseStatusException
end
===========================================================================
title List Discounts
actor user
boundary Spring Dispatcher Serverlet
control AuthInterceptor
control DiscountController
entity discountModel
entity usedDiscountModel

user ->Spring Dispatcher Serverlet : GET /discounts
Spring Dispatcher Serverlet ->AuthInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AuthInterceptor -->Spring Dispatcher Serverlet: True
Spring Dispatcher Serverlet -> DiscountController : listDiscounts(@RequestAttribute("context") Context ctx, @RequestParam(required = false) String serviceName)

alt serviceName doesn't exist
DiscountController ->DiscountController : getEffectiveDiscountsForUser(ctx.email, discountModel.select(d -> d.isActive))
DiscountController ->usedDiscountModel : select(d -> d.email.equals(email))
usedDiscountModel -->DiscountController : ArrayList<UsedDiscount>
DiscountController -->Spring Dispatcher Serverlet : ArrayList<Discount>

else serviceName exists
DiscountController ->DiscountController : getDiscountsForServiceForUser(ctx.email, serviceName)
DiscountController ->discountModel : select(d -> d.isActive && (d.type == DiscountType.OVERALL || (d.type == DiscountType.SPECIFIC && d.serviceName.equals(serviceName))))
discountModel -->DiscountController : ArrayList<Discount>
DiscountController ->DiscountController : getEffectiveDiscountsForUser(email, discounts);
DiscountController ->usedDiscountModel : select(d -> d.email.equals(email))
usedDiscountModel -->DiscountController : ArrayList<UsedDiscount>
DiscountController -->Spring Dispatcher Serverlet : ArrayList<Discount>
end
else returns False
AuthInterceptor -->Spring Dispatcher Serverlet: throws ResponseStatusException
end
=======================================================
title LogIn

actor user
boundary Spring Dispatcher Serverlet
control AuthController
entity "Model<User>" as UserModel

participant Token

activate Spring Dispatcher Serverlet

user->Spring Dispatcher Serverlet:POST /login
Spring Dispatcher Serverlet ->AuthController : logIn(@RequestBody LogInBody body)
activate AuthController
activate UserModel
AuthController ->UserModel : selectOne(u -> u.email.equals(body.email) && u.password.equals(body.password))
UserModel -->AuthController : user

alt user != null
AuthController ->* Token:<<create>>user
Token -->AuthController:
deactivate UserModel
AuthController -->Spring Dispatcher Serverlet : Token
deactivate AuthController
end
activate AuthController
AuthController -->Spring Dispatcher Serverlet:throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Invalid email or password")
deactivate AuthController
======================================================================
title Admin List Refunds
actor admin
boundary Spring Dispatcher Serverlet
control AuthInterceptor
control AdminInterceptor
control AdminRefundController
entity refundModel
participant rrTransactions


admin -> Spring Dispatcher Serverlet : GET /admin/refunds
Spring Dispatcher Serverlet ->AuthInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AuthInterceptor -->Spring Dispatcher Serverlet: True
Spring Dispatcher Serverlet ->AdminInterceptor : preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
alt returns True
AdminInterceptor -->Spring Dispatcher Serverlet : True
Spring Dispatcher Serverlet ->AdminRefundController : listRefundRequests()
AdminRefundController ->refundModel : select(r -> true)
refundModel -->AdminRefundController : Model<RefundRequest>
AdminRefundController ->rrTransactions : add(new RefundRequestResponse(rr, transactionModel.selectOne(t -> t.id == rr.transactionId)))
rrTransactions -->AdminRefundController : ArrayList<RefundRequestResponse>
AdminRefundController -->Spring Dispatcher Serverlet : ArrayList<RefundRequestResponse>
else returns false
AdminInterceptor -->Spring Dispatcher Serverlet : throws ResponseStatusException
end
else returns false
AuthInterceptor -->Spring Dispatcher Serverlet : throws ResponseStatusException

end
